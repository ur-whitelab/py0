<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quick Start &mdash; py0 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="API.html" />
    <link rel="prev" title="PY0" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="toc.html" class="icon icon-home"> py0
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">PY0</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-an-seair-model">Setting-up an SEAIR Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#applying-maxent">Applying MaxEnt</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="toc.html">py0</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="toc.html" class="icon icon-home"></a> &raquo;</li>
      <li>Quick Start</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ur-whitelab/py0" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="quick-start">
<h1>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline"></a></h1>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">py0</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">maxent</span>
</pre></div>
</div>
<section id="setting-up-an-seair-model">
<h2>Setting-up an SEAIR Model<a class="headerlink" href="#setting-up-an-seair-model" title="Permalink to this headline"></a></h2>
<p>Susceptible (<span class="math notranslate nohighlight">\({\bf S}\)</span>) individuals can get exposed
(<span class="math notranslate nohighlight">\({\bf E}\)</span>) to the disease through I-S and A-S contacts with
infectivity rates <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(\beta'\)</span>. Once exposed, they
become asymptomatic (<span class="math notranslate nohighlight">\({\bf A}\)</span>) or infected (<span class="math notranslate nohighlight">\({\bf I}\)</span>) at
rates <span class="math notranslate nohighlight">\(\alpha\)</span> or <span class="math notranslate nohighlight">\(\gamma\)</span>. They finally recover or die at
rate <span class="math notranslate nohighlight">\(\mu\)</span> and become resolved (<span class="math notranslate nohighlight">\({\bf R}\)</span>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make up some population area and mobility network</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">patches</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;patch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)]</span>
<span class="n">population</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">500000</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">300000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">,)))</span>
<span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">,)),</span> <span class="mi">0</span><span class="p">))</span>
<span class="c1"># defining a fully connected mobility matrix</span>
<span class="n">dense_mobility_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">))))</span>
<span class="c1"># setting diagonal values to be dominant</span>
<span class="n">dense_mobility_matrix_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">))))</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">dense_mobility_matrix</span><span class="p">,</span> <span class="n">dense_mobility_matrix_diag</span><span class="p">)</span>
<span class="n">dense_mobility_matrix_norm</span> <span class="o">=</span> <span class="n">dense_mobility_matrix</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dense_mobility_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">compartments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]</span>
<span class="n">full_compartments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">compartments</span>
<span class="n">infections_compartments</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">C</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s make a 10-node contact network with node connection probability of
0.4. The infection starts in node 1 with a single individual exposed.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span><span class="o">=</span><span class="mi">10</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="n">true_node</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">gen_random_graph</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">py0</span><span class="o">.</span><span class="n">draw_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">true_origin</span><span class="o">=</span><span class="n">true_node</span><span class="p">,</span> <span class="n">heatmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/output_5_0.png" src="_images/output_5_0.png" />
<p>Defining diesease parameters:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta_A</span> <span class="o">=</span> <span class="mf">0.025</span>
<span class="n">beta_I</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">alpha</span> <span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span>
<span class="n">gamma</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span>
<span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">7</span>
<span class="n">M</span><span class="o">=</span><span class="mi">10</span>
<span class="n">C</span><span class="o">=</span><span class="mi">4</span>
<span class="n">timesteps</span><span class="o">=</span><span class="mi">250</span>
<span class="c1"># sparsify mobility matrix for sparse graphs</span>
<span class="n">sparsed_mobility_matrix</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">sparse_graph_mobility</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">dense_mobility_matrix</span><span class="p">)</span>
<span class="n">tmat</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">TransitionMatrix</span><span class="p">(</span><span class="n">compartments</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># calling this alpha</span>
<span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># calling this gamma</span>
<span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="n">mu</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># mu</span>
<span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">mu</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># mu</span>
<span class="n">infect_fxn</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">contact_infection_func</span><span class="p">(</span><span class="n">infections_compartments</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">MetaModel</span><span class="p">(</span><span class="n">infect_fxn</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">populations</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">population</span><span class="p">))</span>
<span class="c1"># starting fractions probabilities</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M</span><span class="p">,</span><span class="n">C</span><span class="p">))</span> <span class="c1">#anywhere</span>
<span class="c1"># Assume starting from Node true_node</span>
<span class="n">initial_exposed</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">population</span><span class="p">[</span><span class="n">true_node</span><span class="p">]</span>
<span class="n">start</span><span class="p">[</span><span class="n">true_node</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_exposed</span>
<span class="n">sparsed_mobility_matrix_norm</span> <span class="o">=</span> <span class="n">sparsed_mobility_matrix</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparsed_mobility_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ref_traj</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sparsed_mobility_matrix_norm</span><span class="p">,</span> <span class="n">tmat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beta_A</span><span class="p">,</span><span class="n">beta_I</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ref_traj</span> <span class="o">=</span> <span class="n">ref_traj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="n">py0</span><span class="o">.</span><span class="n">patch_quantile</span><span class="p">(</span><span class="n">ref_traj</span><span class="p">,</span> <span class="n">patch_names</span> <span class="o">=</span> <span class="n">patches</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Plotting</span> <span class="mi">10</span> <span class="n">patches</span> <span class="ow">in</span> <span class="n">a</span> <span class="mi">3</span> <span class="n">x</span> <span class="mi">4</span> <span class="n">grid</span>
</pre></div>
</div>
<img alt="_images/output_7_1.png" src="_images/output_7_1.png" />
</section>
<section id="applying-maxent">
<h2>Applying MaxEnt<a class="headerlink" href="#applying-maxent" title="Permalink to this headline"></a></h2>
<p>We need to obtain a set of observations from the reference trajectory.
This is done by considering weekly averages from compartments I and R.
To account for uncertainty we add 0.05 multiplicative noise and a
Laplace prior of 1.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_restraints</span><span class="p">(</span><span class="n">ref_traj</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">prior</span><span class="p">:</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">maxent</span><span class="o">.</span><span class="n">Laplace</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">maxent</span><span class="o">.</span><span class="n">EmptyPrior</span><span class="p">()</span>
    <span class="n">restrained_patches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">number_of_restrained_patches</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">restraints</span><span class="p">,</span> <span class="n">plot_fxns_list</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">compartment_restrainer</span><span class="p">(</span><span class="n">restrained_patches</span><span class="p">,</span> <span class="n">restrained_compartments</span><span class="p">,</span>
                                                                 <span class="n">ref_traj</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span> <span class="n">npoints</span> <span class="o">=</span> <span class="n">npoints</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">restraints</span><span class="p">,</span> <span class="n">plot_fxns_list</span><span class="p">,</span> <span class="n">restrained_patches</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">npoints</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">number_of_restrained_patches</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">restrained_compartments</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="c1">#(infected patch and recovered)</span>
<span class="n">number_of_restrained_compartments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">restrained_compartments</span><span class="p">)</span>
<span class="n">restrained_compartments_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">full_compartments</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">restrained_compartments</span><span class="p">]</span>
<span class="n">restrained_compartments_names</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">restrained_compartments_names</span><span class="p">)</span>
<span class="n">restraints</span><span class="p">,</span> <span class="n">plot_fxns_list</span><span class="p">,</span> <span class="n">restrained_patches</span> <span class="o">=</span> <span class="n">gen_restraints</span><span class="p">(</span><span class="n">ref_traj</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">140</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Restraints</span> <span class="n">are</span> <span class="nb">set</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">time</span> <span class="nb">range</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">140</span><span class="p">]</span>
<span class="mi">94</span> <span class="mf">0.04975285</span> <span class="mf">0.05273135913584738</span>
<span class="mi">129</span> <span class="mf">0.029316694</span> <span class="mf">0.032077378938796</span>
<span class="mi">115</span> <span class="mf">0.113994256</span> <span class="mf">0.11806512630097674</span>
<span class="mi">122</span> <span class="mf">0.062029254</span> <span class="mf">0.06911402834944823</span>
<span class="mi">101</span> <span class="mf">0.11352191</span> <span class="mf">0.12239990691234638</span>
<span class="mi">52</span> <span class="mf">2.673287e-05</span> <span class="mf">2.7549698356717784e-05</span>
<span class="mi">101</span> <span class="mf">0.191924</span> <span class="mf">0.2019153297462253</span>
<span class="mi">129</span> <span class="mf">0.8771344</span> <span class="mf">0.8756767595708168</span>
<span class="mi">73</span> <span class="mf">0.0014521469</span> <span class="mf">0.0014569129521043063</span>
<span class="mi">115</span> <span class="mf">0.6488122</span> <span class="mf">0.657434425422003</span>
<span class="mi">101</span> <span class="mf">0.15202422</span> <span class="mf">0.13335048824813567</span>
<span class="mi">108</span> <span class="mf">0.1295897</span> <span class="mf">0.11855093982687155</span>
<span class="mi">129</span> <span class="mf">0.015670275</span> <span class="mf">0.015999471032561663</span>
<span class="mi">94</span> <span class="mf">0.0971091</span> <span class="mf">0.09566145227181654</span>
<span class="mi">80</span> <span class="mf">0.011050001</span> <span class="mf">0.011195641006993459</span>
<span class="mi">94</span> <span class="mf">0.14638475</span> <span class="mf">0.1517370546602452</span>
<span class="mi">80</span> <span class="mf">0.012830333</span> <span class="mf">0.01216684885735983</span>
<span class="mi">115</span> <span class="mf">0.77781504</span> <span class="mf">0.8043227674350953</span>
<span class="mi">122</span> <span class="mf">0.86995727</span> <span class="mf">0.8350106644020316</span>
<span class="mi">59</span> <span class="mf">0.0002302867</span> <span class="mf">0.0002223469995590988</span>
<span class="mi">115</span> <span class="mf">0.13835825</span> <span class="mf">0.13071822293735383</span>
<span class="mi">66</span> <span class="mf">0.00016264888</span> <span class="mf">0.00016307311067676058</span>
<span class="mi">59</span> <span class="mf">4.6608624e-05</span> <span class="mf">4.488512328249778e-05</span>
<span class="mi">136</span> <span class="mf">0.029640017</span> <span class="mf">0.03192676602524879</span>
<span class="mi">108</span> <span class="mf">0.1119285</span> <span class="mf">0.10469312348888637</span>
<span class="mi">94</span> <span class="mf">0.026497573</span> <span class="mf">0.026851382651177924</span>
<span class="mi">136</span> <span class="mf">0.8581027</span> <span class="mf">0.8422628830391345</span>
<span class="mi">80</span> <span class="mf">0.0023713694</span> <span class="mf">0.0023429865726260143</span>
<span class="mi">115</span> <span class="mf">0.42736498</span> <span class="mf">0.45086277501101246</span>
<span class="mi">52</span> <span class="mf">1.5562546e-05</span> <span class="mf">1.6072424331065617e-05</span>
<span class="mi">101</span> <span class="mf">0.0154758375</span> <span class="mf">0.016275099274446137</span>
<span class="mi">136</span> <span class="mf">0.061694317</span> <span class="mf">0.06131729141170098</span>
<span class="mi">66</span> <span class="mf">1.5852183e-05</span> <span class="mf">1.7304748997913783e-05</span>
<span class="mi">87</span> <span class="mf">0.0010797285</span> <span class="mf">0.0010761797800807062</span>
<span class="mi">80</span> <span class="mf">0.00026894375</span> <span class="mf">0.00029400630883253943</span>
<span class="mi">52</span> <span class="mf">8.577778e-07</span> <span class="mf">8.52472859684756e-07</span>
<span class="mi">66</span> <span class="mf">1.6428748e-05</span> <span class="mf">1.641476729101499e-05</span>
<span class="mi">122</span> <span class="mf">0.4188746</span> <span class="mf">0.42681544300801927</span>
<span class="mi">136</span> <span class="mf">0.8043432</span> <span class="mf">0.8952062157939408</span>
<span class="mi">101</span> <span class="mf">0.017881801</span> <span class="mf">0.01784401965232122</span>
<span class="mi">94</span> <span class="mf">0.11844369</span> <span class="mf">0.11937055083555247</span>
<span class="mi">122</span> <span class="mf">0.015721513</span> <span class="mf">0.015904024816874356</span>
<span class="mi">101</span> <span class="mf">0.09346652</span> <span class="mf">0.0906750675848937</span>
<span class="mi">66</span> <span class="mf">0.010553201</span> <span class="mf">0.010427658940605282</span>
<span class="mi">129</span> <span class="mf">0.0077456883</span> <span class="mf">0.0071941717183199895</span>
<span class="mi">87</span> <span class="mf">0.24245308</span> <span class="mf">0.23647273705487404</span>
<span class="mi">101</span> <span class="mf">0.61471015</span> <span class="mf">0.6228231062331796</span>
<span class="mi">108</span> <span class="mf">0.7442263</span> <span class="mf">0.7207964741862686</span>
<span class="mi">52</span> <span class="mf">0.0020966823</span> <span class="mf">0.002047173528925783</span>
<span class="mi">80</span> <span class="mf">0.1103488</span> <span class="mf">0.10199891973925207</span>
</pre></div>
</div>
<p>Generating an ensemble of trajectories to apply MaxEnt:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_samples</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">mobility_matrix</span><span class="o">=</span><span class="n">dense_mobility_matrix</span><span class="p">,</span> <span class="n">timesteps</span> <span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">,</span> <span class="n">populations</span> <span class="o">=</span> <span class="n">population</span><span class="p">):</span>
    <span class="c1"># sparsify mobility matrix for sparse graphs</span>
    <span class="n">sparsed_mobility_matrix</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">sparse_graph_mobility</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">mobility_matrix</span><span class="p">)</span>
    <span class="n">tmat</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">TransitionMatrix</span><span class="p">(</span><span class="n">compartments</span><span class="p">,</span> <span class="n">infections_compartments</span><span class="p">)</span>
    <span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># call this alpha</span>
    <span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># call this gamma</span>
    <span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># mu</span>
    <span class="n">tmat</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">hyper_pram</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">ParameterHypers</span><span class="p">()</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">beta_low</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">beta_high</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.08</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">beta_var</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">start_high</span> <span class="o">=</span> <span class="mf">2e-5</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">start_var</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">R_var</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">beta_start</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">start_mean</span> <span class="o">=</span> <span class="mf">8e-6</span>
    <span class="n">hyper_pram</span><span class="o">.</span><span class="n">start_scale</span> <span class="o">=</span> <span class="mf">1e-7</span>
    <span class="n">start_logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M</span><span class="p">))</span>
    <span class="n">param_model</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">MetaParameterJoint</span><span class="p">(</span><span class="n">start_logits</span><span class="p">,</span> <span class="n">sparsed_mobility_matrix</span> <span class="p">,</span> <span class="n">tmat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;unbiased_model&#39;</span><span class="p">,</span>
                                              <span class="n">hypers</span> <span class="o">=</span> <span class="n">hyper_pram</span><span class="p">,</span> <span class="n">n_infectious_compartments</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">tqdm</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">total_batches</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">batches</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">infect</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">contact_infection_func</span><span class="p">(</span><span class="n">infections_compartments</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">MetaModel</span><span class="p">(</span><span class="n">infect</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">populations</span> <span class="o">=</span> <span class="n">population</span><span class="p">)</span>
    <span class="n">prior_prams</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">batches</span><span class="p">)):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">param_model</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">prior_prams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
        <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">ps</span><span class="p">))</span>
    <span class="n">trajs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trajs</span>
<span class="n">trajs</span> <span class="o">=</span> <span class="n">gen_samples</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">timesteps</span> <span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">,</span> <span class="n">populations</span> <span class="o">=</span> <span class="n">population</span><span class="p">)</span>
<span class="n">prior_exposed_patch</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">exposed_finder</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 16/16 [00:32&lt;00:00,  2.01s/it]
</pre></div>
</div>
<p>Applying MaxEnt:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">ReduceLROnPlateau</span>
<span class="k">def</span> <span class="nf">maxent_fit</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">restraints</span><span class="p">):</span>
    <span class="n">me_model</span> <span class="o">=</span> <span class="n">maxent</span><span class="o">.</span><span class="n">MaxentModel</span><span class="p">(</span><span class="n">restraints</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
    <span class="n">me_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>
    <span class="n">reduce_lr</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                              <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">me_history</span> <span class="o">=</span> <span class="n">me_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">trajs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">reduce_lr</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">me_model</span>
<span class="n">me_model</span> <span class="o">=</span> <span class="n">maxent_fit</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">restraints</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compare_patches</span><span class="p">(</span><span class="n">ref_traj</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span> <span class="n">weights_dict</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">restrained_patches</span><span class="p">,</span> <span class="n">plot_fxns_list</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">patch_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span> <span class="n">kw_args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;does traj_quantile for trajectories of shape [ntrajs, time, patches, compartments]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_dict</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
    <span class="n">NP</span> <span class="o">=</span> <span class="n">trajs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">NP</span><span class="p">)))</span>
    <span class="n">ncol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NP</span> <span class="o">/</span> <span class="n">nrow</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Plotting </span><span class="si">{</span><span class="n">NP</span><span class="si">}</span><span class="s1"> patches in a </span><span class="si">{</span><span class="n">nrow</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">ncol</span><span class="si">}</span><span class="s1"> grid&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span> <span class="o">==</span> <span class="n">NP</span><span class="p">:</span>
                <span class="k">break</span>
<span class="c1">#             traj_quantile(trajs[:,:,i * ncol + j,:], weights=weights, names=full_compartments, ax=axs[0,i])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ref_traj</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="p">,:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;unbiased&#39;</span><span class="p">:</span>
                <span class="n">py0</span><span class="o">.</span><span class="n">traj_quantile</span><span class="p">(</span><span class="n">trajs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                              <span class="n">add_legend</span><span class="o">=</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;biased&#39;</span><span class="p">:</span>
                <span class="n">py0</span><span class="o">.</span><span class="n">traj_quantile</span><span class="p">(</span><span class="n">trajs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span><span class="n">weights</span><span class="o">=</span> <span class="n">weights</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                              <span class="n">add_legend</span><span class="o">=</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;hyper-biased&#39;</span><span class="p">:</span>
                <span class="n">py0</span><span class="o">.</span><span class="n">traj_quantile</span><span class="p">(</span><span class="n">hme_model</span><span class="o">.</span><span class="n">trajs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span><span class="n">weights</span><span class="o">=</span> <span class="n">weights</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                              <span class="n">add_legend</span><span class="o">=</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rtraj</span><span class="p">[</span><span class="n">p</span><span class="p">,:,</span><span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="p">,:])</span>
<span class="c1">#             ax[i, j].set_ylim(0, 1)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">restrained_patches</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;unbiased&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">pf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_fxns_list</span><span class="p">[</span><span class="n">restrained_patches</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="p">)]):</span>
                    <span class="n">pf</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#             plt.tight_layout()</span>
            <span class="k">if</span> <span class="n">patch_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">trajs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span>
                              <span class="sa">f</span><span class="s1">&#39;Patch </span><span class="si">{</span><span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">patch_names</span> <span class="o">=</span> <span class="n">patch_names</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">patch_names</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nrow</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">ncol</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">NP</span> <span class="o">%</span> <span class="n">ncol</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">nrow</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (days)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<p>Let’s have a look at the posterior trajectory. The dashed lines are the
reference trajectory and the red markers are observation data points
coming from patches with blue highlighted edges.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;unbiased&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;biased&#39;</span><span class="p">:</span><span class="n">me_model</span><span class="o">.</span><span class="n">traj_weights</span><span class="p">}</span>
<span class="n">compare_patches</span><span class="p">(</span><span class="n">ref_traj</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span> <span class="n">weights_dict</span><span class="p">,</span><span class="s1">&#39;biased&#39;</span><span class="p">,</span> <span class="n">restrained_patches</span><span class="p">,</span> <span class="n">plot_fxns_list</span><span class="p">,</span>
                <span class="n">patch_names</span> <span class="o">=</span> <span class="n">patches</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">full_compartments</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Plotting</span> <span class="mi">10</span> <span class="n">patches</span> <span class="ow">in</span> <span class="n">a</span> <span class="mi">3</span> <span class="n">x</span> <span class="mi">4</span> <span class="n">grid</span>
</pre></div>
</div>
<img alt="_images/output_18_1.png" src="_images/output_18_1.png" />
<p>Finally, we can have a look at model’s patient-zero origin inference:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_w</span> <span class="o">=</span> <span class="n">me_model</span><span class="o">.</span><span class="n">traj_weights</span>
<span class="n">exposed_prob</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">weighted_exposed_prob_finder</span><span class="p">(</span>
                            <span class="n">prior_exposed_patch</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">weighted_exposed_prob</span> <span class="o">=</span> <span class="n">py0</span><span class="o">.</span><span class="n">weighted_exposed_prob_finder</span><span class="p">(</span>
                            <span class="n">prior_exposed_patch</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">me_w</span><span class="p">)</span>
<span class="n">py0</span><span class="o">.</span><span class="n">draw_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_exposed_prob</span><span class="p">,</span> <span class="n">heatmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">true_origin</span><span class="o">=</span><span class="n">true_node</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/output_20_0.png" src="_images/output_20_0.png" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="PY0" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="API.html" class="btn btn-neutral float-right" title="API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Mehrad Ansari, Andrew White.
      <span class="lastupdated">Last updated on True.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>